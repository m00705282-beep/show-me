<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Dashboard | Crypto Arbitrage</title>
  <style>
    :root{
      --bg:#0a0e14; --card:#131821; --border:#1d2433; --text:#e6eef6;
      --green:#19c37d; --red:#ff6b6b; --blue:#4f7cff; --yellow:#ffd166;
      --muted:#6b7a8f;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',system-ui,sans-serif;
      background:linear-gradient(135deg,#0a0e14,#151b24);
      color:var(--text);
      min-height:100vh;
      padding:20px;
    }
    
    /* Header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
      padding:16px 20px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
    }
    .header h1{font-size:24px;font-weight:700}
    .header .status{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:14px;
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--green);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    
    /* Grid Layout */
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    @media(max-width:1200px){.grid{grid-template-columns:1fr}}
    
    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .card-header{
      padding:14px 18px;
      border-bottom:1px solid var(--border);
      font-weight:600;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .card-body{padding:18px}
    
    /* Stats */
    .stats{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    .stat{
      padding:16px;
      background:rgba(79,124,255,0.05);
      border:1px solid var(--border);
      border-radius:8px;
      text-align:center;
    }
    .stat-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      text-transform:uppercase;
    }
    .stat-value{
      font-size:28px;
      font-weight:700;
      color:var(--text);
    }
    .stat-value.green{color:var(--green)}
    .stat-value.red{color:var(--red)}
    .stat-value.blue{color:var(--blue)}
    
    /* Exchanges List */
    .exchanges{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:10px;
    }
    .exchange-item{
      padding:12px 14px;
      background:linear-gradient(135deg,rgba(79,124,255,0.08),rgba(25,195,125,0.05));
      border:1px solid var(--border);
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:all 0.2s;
    }
    .exchange-item:hover{
      transform:translateY(-2px);
      border-color:var(--blue);
    }
    .exchange-name{
      font-weight:600;
      font-size:13px;
      text-transform:uppercase;
    }
    .exchange-balance{
      font-size:14px;
      font-weight:700;
      color:var(--green);
    }
    .exchange-balance.zero{color:var(--muted);opacity:0.5}
    
    /* Profit Chart */
    .profit-chart{
      height:180px;
      display:flex;
      align-items:flex-end;
      gap:4px;
      padding:10px 0;
    }
    .bar{
      flex:1;
      background:linear-gradient(to top,var(--green),var(--blue));
      border-radius:4px 4px 0 0;
      min-height:10px;
      position:relative;
      transition:all 0.3s;
    }
    .bar:hover{opacity:0.8}
    .bar.negative{background:linear-gradient(to top,var(--red),#ff8888)}
    
    /* Recent Trades */
    .trades-list{
      max-height:400px;
      overflow-y:auto;
    }
    .trade-item{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:background 0.2s;
    }
    .trade-item:hover{background:rgba(79,124,255,0.05)}
    .trade-item:last-child{border-bottom:none}
    .trade-info{flex:1}
    .trade-coin{
      font-weight:600;
      font-size:14px;
      margin-bottom:4px;
    }
    .trade-route{
      font-size:12px;
      color:var(--muted);
    }
    .trade-profit{
      text-align:right;
    }
    .trade-amount{
      font-size:16px;
      font-weight:700;
    }
    .trade-amount.positive{color:var(--green)}
    .trade-amount.negative{color:var(--red)}
    .trade-time{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    
    /* Loading */
    .loading{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:40px;
      color:var(--muted);
    }
    
    /* Refresh Button */
    .refresh-btn{
      padding:6px 12px;
      background:var(--blue);
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:12px;
      font-weight:600;
      transition:all 0.2s;
    }
    .refresh-btn:hover{background:#5a8aff;transform:scale(1.05)}
    .refresh-btn:disabled{opacity:0.5;cursor:not-allowed}
    
    /* Nav */
    .nav{
      display:flex;
      gap:8px;
      margin-top:16px;
    }
    .nav a{
      padding:10px 20px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:8px;
      color:var(--text);
      text-decoration:none;
      font-size:13px;
      font-weight:600;
      transition:all 0.2s;
    }
    .nav a:hover{border-color:var(--blue);color:var(--blue)}
    .nav a.active{background:var(--blue);border-color:var(--blue);color:white}
    
    /* Scrollbar */
    ::-webkit-scrollbar{width:8px}
    ::-webkit-scrollbar-track{background:var(--bg)}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:var(--blue)}
    
    /* Utility classes */
    .flex{
      display:flex;
    }
    .justify-between{
      justify-content:space-between;
    }
    .align-items-center{
      align-items:center;
    }
    .gap-8px{
      gap:8px;
    }
    .gap-12px{
      gap:12px;
    }
    .padding-10px{
      padding:10px;
    }
    .padding-16px{
      padding:16px;
    }
    .padding-20px{
      padding:20px;
    }
    .padding-24px{
      padding:24px;
    }
    .padding-32px{
      padding:32px;
    }
    .font-size-11px{
      font-size:11px;
    }
    .font-size-12px{
      font-size:12px;
    }
    .font-size-13px{
      font-size:13px;
    }
    .font-size-14px{
      font-size:14px;
    }
    .font-size-16px{
      font-size:16px;
    }
    .font-size-24px{
      font-size:24px;
    }
    .font-size-28px{
      font-size:28px;
    }
    .font-weight-500{
      font-weight:500;
    }
    .font-weight-600{
      font-weight:600;
    }
    .font-weight-700{
      font-weight:700;
    }
    .color-white{
      color:white;
    }
    .color-blue{
      color:var(--blue);
    }
    .color-green{
      color:var(--green);
    }
    .color-red{
      color:var(--red);
    }
    .color-muted{
      color:var(--muted);
    }
    .background-blue{
      background:var(--blue);
    }
    .background-green{
      background:var(--green);
    }
    .background-red{
      background:var(--red);
    }
    .background-card{
      background:var(--card);
    }
    .background-border{
      background:var(--border);
    }
    .border-radius-6px{
      border-radius:6px;
    }
    .border-radius-8px{
      border-radius:8px;
    }
    .border-radius-12px{
      border-radius:12px;
    }
    .transition-0-2s{
      transition:all 0.2s;
    }
    .transition-0-3s{
      transition:all 0.3s;
    }
    .transform-scale-1-05{
      transform:scale(1.05);
    }
    .transform-translate-y-1px{
      transform:translateY(-1px);
    }
    .transform-translate-y-2px{
      transform:translateY(-2px);
    }
    .box-shadow-0-12px-20px{
      box-shadow:0 12px 20px rgba(59, 130, 246, 0.2);
    }
    .box-shadow-0-12px-24px{
      box-shadow:0 12px 24px rgba(59, 130, 246, 0.25);
    }
    .cursor-pointer{
      cursor:pointer;
    }
    .opacity-0-5{
      opacity:0.5;
    }
    .opacity-0-8{
      opacity:0.8;
    }
    
    /* Header */
    .header{
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 64, 175, 0.6));
      color: #fff;
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(96, 165, 250, 0.2);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* Toolbar */
    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    .toolbar-actions{
      display:flex;
      gap:12px;
    }
    .btn-primary{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      border-radius:8px;
      background:linear-gradient(135deg,#2563eb,#4338ca);
      border:none;
      color:#fff;
      font-weight:500;
      cursor:pointer;
      transition:transform 0.2s ease,box-shadow 0.2s ease;
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(59,130,246,0.25);
    }
    .btn-secondary{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      border-radius:8px;
      background:rgba(59,130,246,0.15);
      border:1px solid rgba(59,130,246,0.4);
      color:#60a5fa;
      font-weight:500;
      cursor:pointer;
      transition:transform 0.2s ease,box-shadow 0.2s ease;
    }
    .btn-secondary:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 20px rgba(59,130,246,0.2);
    }
    .count-muted{
      font-size:11px;
      color:var(--muted);
    }
    .card-spaced{
      margin-bottom:20px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üí∞ Trading Dashboard</h1>
    <div class="status">
      <span class="dot"></span>
      <span>Live</span>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">üîÑ Refresh</button>
    </div>
  </div>
  
  <div class="grid">
    <!-- Portfolio Overview -->
    <div class="card">
      <div class="card-header">
        <span>üìä Portfolio Overview</span>
        <span id="lastUpdate" class="font-size-11px color-muted"></span>
      </div>
      <div class="card-body">
        <div class="toolbar">
          <div>
            <div class="section-title">üöÄ Live Arbitrage Opportunities</div>
            <div class="metrics-subtitle">Automatically filtered for spreads above 1.0%</div>
          </div>
          <div class="toolbar-actions">
            <button class="btn-primary" onclick="refreshOpportunities()">üîÑ Refresh Opportunities</button>
            <button class="btn-secondary" onclick="downloadOpportunities()">üì• Export CSV</button>
          </div>
        </div>
        <div class="stats">
          <div class="stat">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value blue" id="totalBalance">$0.00</div>
          </div>
          <div class="stat">
            <div class="stat-label">Today's Profit</div>
            <div class="stat-value green" id="todayProfit">$0.00</div>
          </div>
          <div class="stat">
            <div class="stat-label">ROI</div>
            <div class="stat-value" id="roi">0.0%</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Active Exchanges -->
    <div class="card">
      <div class="card-header">
        <span>üîó Active Exchanges</span>
        <span id="exchangeCount" class="count-muted">0 connected</span>
      </div>
      <div class="card-body">
        <div class="exchanges" id="exchangesList">
          <div class="loading">Loading exchanges...</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Profit History -->
  <div class="card card-spaced">
    <div class="card-header">
      <span>üìà Profit History (Last 24h)</span>
    </div>
    <div class="card-body">
      <div class="profit-chart" id="profitChart">
        <div class="loading">Loading chart...</div>
      </div>
    </div>
  </div>
  
  <!-- Recent Trades -->
  <div class="card">
    <div class="card-header">
      <span>‚ö° Recent Trades</span>
      <span id="tradeCount" class="count-muted">0 trades</span>
    </div>
    <div class="card-body">
      <div class="trades-list" id="tradesList">
        <div class="loading">Loading trades...</div>
      </div>
    </div>
  </div>
  
  <!-- Navigation -->
  <div class="nav">
    <a href="/trading.html" class="active">üí∞ Trading</a>
    <a href="/analytics.html">üìä Analytics</a>
    <a href="/index.html">üîç Opportunities</a>
  </div>
  
  <script>
    let refreshing = false;
    
    async function refreshData() {
      if (refreshing) return;
      refreshing = true;
      document.getElementById('refreshBtn').disabled = true;
      
      try {
        await Promise.all([
          loadPortfolio(),
          loadExchanges(),
          loadTrades()
        ]);
      } catch (err) {
        console.error('Refresh failed:', err);
      }
      
      refreshing = false;
      document.getElementById('refreshBtn').disabled = false;
    }
    
    async function loadPortfolio() {
      try {
        const res = await fetch('/api/realtrading/status');
        const data = await res.json();
        
        // Update stats
        document.getElementById('totalBalance').textContent = '$' + (data.totalAvailableUSD || 0).toFixed(2);
        document.getElementById('todayProfit').textContent = '$' + (data.dailyProfit || 0).toFixed(2);
        document.getElementById('todayProfit').className = 'stat-value ' + (data.dailyProfit >= 0 ? 'green' : 'red');
        
        const roi = data.dailyVolume > 0 ? (data.dailyProfit / data.dailyVolume * 100) : 0;
        document.getElementById('roi').textContent = roi.toFixed(2) + '%';
        document.getElementById('roi').className = 'stat-value ' + (roi >= 0 ? 'green' : 'red');
        
        document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
      } catch (err) {
        console.error('Portfolio load failed:', err);
      }
    }
    
    async function loadExchanges() {
      try {
        const res = await fetch('/api/realtrading/status');
        const data = await res.json();
        const balances = data.realBalances || {};
        
        const list = document.getElementById('exchangesList');
        list.innerHTML = '';
        
        const exchanges = Object.entries(balances);
        document.getElementById('exchangeCount').textContent = exchanges.length + ' connected';
        
        exchanges
          .sort((a, b) => {
            const balA = a[1].USDT?.free || a[1].USD?.free || 0;
            const balB = b[1].USDT?.free || b[1].USD?.free || 0;
            return balB - balA;
          })
          .forEach(([name, balance]) => {
            const usdtFree = balance.USDT?.free || 0;
            const usdFree = balance.USD?.free || 0;
            const total = usdtFree || usdFree;
            
            const item = document.createElement('div');
            item.className = 'exchange-item';
            item.innerHTML = `
              <span class="exchange-name">${name}</span>
              <span class="exchange-balance ${total === 0 ? 'zero' : ''}">$${total.toFixed(2)}</span>
            `;
            list.appendChild(item);
          });
      } catch (err) {
        console.error('Exchanges load failed:', err);
        document.getElementById('exchangesList').innerHTML = '<div class="loading">Failed to load</div>';
      }
    }
    
    async function loadTrades() {
      try {
        const res = await fetch('/api/realtrading/history?limit=20');
        const data = await res.json();
        const trades = data.trades || [];
        
        const list = document.getElementById('tradesList');
        document.getElementById('tradeCount').textContent = trades.length + ' trades';
        
        if (trades.length === 0) {
          list.innerHTML = '<div class="loading">No recent trades</div>';
          return;
        }
        
        list.innerHTML = trades.map(trade => {
          const profit = trade.profit || 0;
          const isProfitable = profit > 0;
          const time = new Date(trade.timestamp).toLocaleString();
          
          // Parse exchange from format "binance/kraken"
          const [buyEx, sellEx] = (trade.exchange || '').split('/');
          
          return `
            <div class="trade-item">
              <div class="trade-info">
                <div class="trade-coin">${trade.coin || 'N/A'}</div>
                <div class="trade-route">${buyEx || 'N/A'} ‚Üí ${sellEx || 'N/A'}</div>
              </div>
              <div class="trade-profit">
                <div class="trade-amount ${isProfitable ? 'positive' : 'negative'}">
                  ${isProfitable ? '+' : ''}$${profit.toFixed(2)}
                </div>
                <div class="trade-time">${time}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Trades load failed:', err);
        document.getElementById('tradesList').innerHTML = '<div class="loading">Failed to load trades</div>';
      }
    }
    
    // Auto-refresh every 30 seconds
    setInterval(refreshData, 30000);
    
    // Initial load
    refreshData();
  </script>
</body>
</html>
